<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP访问记录 - 管理面板</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 1.8rem;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        button {
            background-color: #3949ab;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #303f9f;
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1a237e;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #444;
            border-bottom: 2px solid #eee;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .ip-address {
            font-family: monospace;
            font-weight: bold;
            color: #1a237e;
        }
        
        .location {
            color: #388e3c;
        }
        
        .time {
            color: #666;
            font-size: 0.9em;
        }
        
        .browser-info {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        .copy-btn {
            background-color: #4caf50;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .copy-btn:hover {
            background-color: #388e3c;
        }
        
        .export-btn {
            background-color: #ff9800;
        }
        
        .export-btn:hover {
            background-color: #f57c00;
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            th, td {
                padding: 10px 5px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>IP访问记录管理面板</h1>
            <div class="controls">
                <button onclick="refreshData()" id="refresh-btn">刷新数据</button>
                <button onclick="exportData()" class="export-btn">导出数据</button>
                <button onclick="clearData()" class="clear-btn">清空记录</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="total-visits">0</div>
                <div class="stat-label">总访问次数</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="unique-ips">0</div>
                <div class="stat-label">独立IP数</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="today-visits">0</div>
                <div class="stat-label">今日访问</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="last-visit">--</div>
                <div class="stat-label">最近访问</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="visits-table">
                <thead>
                    <tr>
                        <th>IP地址</th>
                        <th>位置</th>
                        <th>访问时间</th>
                        <th>浏览器/设备</th>
                        <th>来源</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="visits-body">
                    <!-- 数据将通过JavaScript填充 -->
                </tbody>
            </table>
            <div id="empty-message" class="empty-state" style="display: none;">
                <h3>暂无访问记录</h3>
                <p>当有人访问追踪页面后，数据将显示在这里。</p>
            </div>
        </div>
    </div>

    <script>
        // 加载并显示访问记录
        function loadVisits() {
            try {
                const visits = JSON.parse(localStorage.getItem('ipTrackerVisits') || '[]');
                const tbody = document.getElementById('visits-body');
                const emptyMessage = document.getElementById('empty-message');
                
                // 清空现有内容
                tbody.innerHTML = '';
                
                if (visits.length === 0) {
                    emptyMessage.style.display = 'block';
                    updateStats([]);
                    return;
                }
                
                emptyMessage.style.display = 'none';
                
                // 按时间倒序排列（最新的在最前面）
                visits.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // 填充表格
                visits.forEach(visit => {
                    const row = document.createElement('tr');
                    
                    // 格式化时间
                    const visitTime = new Date(visit.time);
                    const formattedTime = visitTime.toLocaleString('zh-CN');
                    const timeAgo = getTimeAgo(visitTime);
                    
                    row.innerHTML = `
                        <td>
                            <span class="ip-address">${visit.ip}</span>
                        </td>
                        <td class="location">${visit.location || '未知'}</td>
                        <td>
                            <div>${formattedTime}</div>
                            <div class="time">${timeAgo}</div>
                        </td>
                        <td class="browser-info" title="${visit.browser.userAgent}">
                            ${getBrowserName(visit.browser.userAgent)}
                        </td>
                        <td>${visit.browser.referrer || '直接访问'}</td>
                        <td>
                            <button onclick="copyToClipboard('${visit.ip}')" class="copy-btn">复制IP</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // 更新统计信息
                updateStats(visits);
                
            } catch (error) {
                console.error('加载访问记录时出错:', error);
                document.getElementById('visits-body').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: red;">
                            加载数据时出错: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // 更新统计数据
        function updateStats(visits) {
            document.getElementById('total-visits').textContent = visits.length;
            
            // 计算独立IP数
            const uniqueIPs = new Set(visits.map(v => v.ip)).size;
            document.getElementById('unique-ips').textContent = uniqueIPs;
            
            // 计算今日访问数
            const today = new Date().toDateString();
            const todayVisits = visits.filter(v => new Date(v.time).toDateString() === today).length;
            document.getElementById('today-visits').textContent = todayVisits;
            
            // 显示最近访问时间
            if (visits.length > 0) {
                const latestVisit = new Date(visits[0].time);
                const timeAgo = getTimeAgo(latestVisit);
                document.getElementById('last-visit').textContent = timeAgo;
            } else {
                document.getElementById('last-visit').textContent = '--';
            }
        }
        
        // 获取浏览器名称
        function getBrowserName(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            if (userAgent.includes('MSIE') || userAgent.includes('Trident/')) return 'IE';
            return '其他浏览器';
        }
        
        // 获取相对时间（如"2小时前"）
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '刚刚';
            if (diffMins < 60) return `${diffMins}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            if (diffDays < 30) return `${diffDays}天前`;
            return '超过一个月前';
        }
        
        // 复制IP地址到剪贴板
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert(`已复制IP地址: ${text}`);
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }
        
        // 导出数据为JSON文件
        function exportData() {
            try {
                const visits = JSON.parse(localStorage.getItem('ipTrackerVisits') || '[]');
                if (visits.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }
                
                const dataStr = JSON.stringify(visits, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(dataBlob);
                downloadLink.download = `ip-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                alert(`已导出 ${visits.length} 条记录`);
            } catch (error) {
                console.error('导出数据时出错:', error);
                alert('导出失败: ' + error.message);
            }
        }
        
        // 清空所有记录
        function clearData() {
            if (confirm('确定要清空所有访问记录吗？此操作不可撤销。')) {
                localStorage.removeItem('ipTrackerVisits');
                loadVisits();
                alert('所有记录已清空');
            }
        }
        
        // 刷新数据
        function refreshData() {
            loadVisits();
            const btn = document.getElementById('refresh-btn');
            btn.innerHTML = '刷新中...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '刷新数据';
                btn.disabled = false;
                alert('数据已刷新');
            }, 500);
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', loadVisits);
        
        // 添加键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshData();
            }
        });
    </script>
</body>
</html>